<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slap Jack Card Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: url('data:image/x-icon;base64,AAACAAEAICAQAAAAAADoAgAAFgAAACgAAAAgAAAAQAAAAAEABAAAAAAAAAIAAAAAAAAAAAAAEAAAAAAAAAAAAAAAOzk7AEApSgBwZ3AAIiEvAIZ7hgAnJzIAPjxPABQIFgAyNGAAEhAjAF1WXQBDRXMATkRRAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKqqiAAAAAAAAAAAAAAAAACqqogAAAAAAAAAAAAAAAAAqmYiAAAAAAAAAAAAAAAAAKpmIgAAAAAAAKqqAAAAAKoRIiIAAAAAAACqqgAAAACqESIiAAAAAAAAqmaqqgCqzEQAAAAAAAAAAKpmqqoAqsxEAAAAAAAAAAAAqmZ3qplEAAAAAAAAAAAAAKpmd6qZRAAAAAAAAAAAAAAAqt27IgAAAAAAAAAAAAAAAKrduyIAAAAAAAAAAAAAAKp3ZjMzIgAAAAAAAAAAAACqd2YzMyIAAAAAAAAAAACqd2Z3IjMiAAAAAAAAAAAAqndmdyIzIgAAAAAAAAAAqndm3SIAIrsiAAAAAAAAAKp3Zt0iACK7IgAAAAAAAKp3Zt0iAAAAIiIAAAAAAACqd2bdIgAAACIiAAAAAACqu927IgAAAAAAAAAAAAAAqrvduyIAAAAAAAAAAAAAqjPdMyIAAAAAAAAAAAAAAKoz3TMiAAAAAAAAAAAAAKpV3VUiAAAAAAAAAAAAAACqVd1VIgAAAAAAAAAAAACqVTNVIgAAAAAAAAAAAAAAqlUzVSIAAAAAAAAAAAAAAKpVVSIAAAAAAAAAAAAAAACqVVUiAAAAAAAAAAAAAAAAIiIiAAAAAAAAAAAAAAAAACIiIgAAAAAAAAAAAAAAAAD////A////wP///8D////A//D/AP/w/wD/8AwP//AMD//8AD///AA///8A////AP///AA///wAP//wAD//8AA//8AMD//ADA//AD8P/wA/D/wA///8AP//8AP///AD///AD///wA///wA///8AP///AP///wD///8D////A////w=='), auto;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            cursor: url('data:image/x-icon;base64,AAACAAEAICAQAAAAAADoAgAAFgAAACgAAAAgAAAAQAAAAAEABAAAAAAAAAIAAAAAAAAAAAAAEAAAAAAAAAAAAAAAOzk7AEApSgBwZ3AAIiEvAIZ7hgAnJzIAPjxPABQIFgAyNGAAEhAjAF11WXQBDRXMATkRRAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKqqiAAAAAAAAAAAAAAAAACqqogAAAAAAAAAAAAAAAAAqmYiAAAAAAAAAAAAAAAAAKpmIgAAAAAAAKqqAAAAAKoRIiIAAAAAAACqqgAAAACqESIiAAAAAAAAqmaqqgCqzEQAAAAAAAAAAKpmqqoAqsxEAAAAAAAAAAAAqmZ3qplEAAAAAAAAAAAAAKpmd6qZRAAAAAAAAAAAAAAAqt27IgAAAAAAAAAAAAAAAKrduyIAAAAAAAAAAAAAAKp3ZjMzIgAAAAAAAAAAAACqd2YzMyIAAAAAAAAAAACqd2Z3IjMiAAAAAAAAAAAAqndmdyIzIgAAAAAAAAAAqndm3SIAIrsiAAAAAAAAAKp3Zt0iACK7IgAAAAAAAKp3Zt0iAAAAIiIAAAAAAACqd2bdIgAAACIiAAAAAACqu927IgAAAAAAAAAAAAAAqrvduyIAAAAAAAAAAAAAqjPdMyIAAAAAAAAAAAAAAKoz3TMiAAAAAAAAAAAAAKpV3VUiAAAAAAAAAAAAAACqVd1VIgAAAAAAAAAAAACqVTNVIgAAAAAAAAAAAAAAqlUzVSIAAAAAAAAAAAAAAKpVVSIAAAAAAAAAAAAAAACqVVUiAAAAAAAAAAAAAAAAIiIiAAAAAAAAAAAAAAAAACIiIgAAAAAAAAAAAAAAAAD////A////wP///8D////A//D/AP/w/wD/8AwP//AMD//8AD///AA///8A////AP///AA///wAP//wAD//8AA//8AMD//ADA//AD8P/wA/D/wA///8AP//8AP///AD///AD///wA///wA///8AP///AP///wD///8D////A////w=='), auto;
            overflow-x: hidden;
        }

        .menu-screen {
            text-align: center;
            margin-top: 2em;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .menu-screen h1, .menu-screen h2 {
            color: #333;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .menu-screen button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .menu-screen button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .menu-screen button:hover::before {
            left: 100%;
        }

        .menu-screen button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            color: #495057;
        }

        .scores {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            font-size: 1.2em;
            font-weight: bold;
            flex-wrap: wrap;
            gap: 10px;
        }

        .score {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .score.winner {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
        }

        .score::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .score:hover::before {
            left: 100%;
        }

        .game-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            min-height: 200px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .player-area {
            text-align: center;
            flex: 1;
            min-width: 180px;
            border: 2px solid #333;
            padding: 15px;
            border-radius: 15px;
            user-select: none;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .player-area.active {
            border-color: #2ecc71;
            box-shadow: 0 0 20px #2ecc71, 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: scale(1.02);
            background: linear-gradient(145deg, #d4edda, #c3e6cb);
        }

        .player-area h3 {
            margin-bottom: 15px;
            color: #555;
            font-size: 1.3em;
        }

        .input-method {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            font-weight: bold;
        }

        .player-status {
            font-size: 0.8em;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.05);
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .card-count {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .pile-area {
            flex: 2;
            text-align: center;
            position: relative;
            border: 2px solid #444;
            padding: 20px;
            border-radius: 15px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card {
            width: 80px;
            height: 120px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            margin: 0 auto;
            user-select: none;
        }

        .card:hover {
            transform: translateY(-5px) rotate(2deg);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .card.jack {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            border-color: #ff4757;
            animation: pulse 1s infinite;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .card.face-down {
            background: repeating-linear-gradient(
                45deg,
                #444,
                #444 5px,
                #666 5px,
                #666 10px
            );
            color: transparent;
        }

        .card.dealt {
            animation: dealCard 0.5s ease-out;
        }

        @keyframes dealCard {
            0% { transform: scale(0.5) rotate(-180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .controls {
            text-align: center;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .message {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1.2em;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.success {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.info {
            background: linear-gradient(45deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .message.error {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .slap-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 200px;
            border: 4px solid #ff4757;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff4757;
            font-weight: bold;
            font-size: 2em;
            opacity: 0.7;
            transition: all 0.3s ease;
            user-select: none;
            touch-action: manipulation;
            cursor: pointer;
            background: rgba(255, 71, 87, 0.1);
        }

        .slap-zone:hover {
            opacity: 1;
            border-color: #ff4757;
            background: rgba(255, 107, 107, 0.2);
            transform: translate(-50%, -50%) scale(1.05);
        }

        .slap-zone:active {
            background: rgba(255, 107, 107, 0.4);
            border-color: #ff4757;
            transform: translate(-50%, -50%) scale(0.95);
        }

        .slap-zone.active {
            animation: slapPulse 0.5s infinite;
        }

        @keyframes slapPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        .power-up {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            animation: powerUpGlow 2s infinite;
        }

        @keyframes powerUpGlow {
            0%, 100% { box-shadow: 0 0 5px #ff6b6b; }
            50% { box-shadow: 0 0 20px #ff6b6b, 0 0 30px #ff6b6b; }
        }

        .hidden {
            display: none;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            animation: particleFloat 1s ease-out forwards;
        }

        @keyframes particleFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(0.5); }
        }

        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .player-area {
                min-width: auto;
                width: 100%;
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div id="main-menu" class="menu-screen">
        <h1>🎴 Slap Jack 🎴</h1>
        <button id="btn-computer">Play vs Computer</button>
        <button id="btn-multiplayer">Multiplayer (2-4 Players)</button>
        <button id="btn-tournament">Tournament Mode (2v2)</button>
        <button id="btn-settings">Settings</button>
    </div>

    <!-- Multiplayer Menu -->
    <div id="multiplayer-menu" class="menu-screen" style="display:none;">
        <h2>Multiplayer Options</h2>
        <p style="margin-bottom: 20px; color: #666;">All players are human - compete with friends!</p>
        <button id="btn-2p">2 Players (Click vs Spacebar)</button>
        <button id="btn-3p">3 Players (Click, Spacebar, Return)</button>
        <button id="btn-4p">4 Players (Click, Spacebar, Return, R)</button>
        <br />
        <button id="btn-back-mp">Back</button>
    </div>

    <!-- Settings Menu -->
    <div id="settings-menu" class="menu-screen" style="display:none;">
        <h2>Game Settings</h2>
        <div style="margin: 20px 0;">
            <label>Slap Time Limit: <input type="range" id="slap-timer" min="1" max="5" value="2.5" step="0.5"> <span id="timer-value">2.5s</span></label>
        </div>
        <div style="margin: 20px 0;">
            <label><input type="checkbox" id="sound-toggle" checked> Enable Sound Effects</label>
        </div>
        <div style="margin: 20px 0;">
            <label><input type="checkbox" id="animations-toggle" checked> Enable Animations</label>
        </div>
        <button id="btn-back-settings">Back</button>
    </div>

    <!-- Game Screen -->
    <div id="game-container" class="game-container">
        <div class="header">
            <h1>🎴 Slap Jack 🎴</h1>
        </div>

        <div class="game-stats" id="game-stats">
            <div class="stat">Round: <span id="round-count">1</span></div>
            <div class="stat">Total Slaps: <span id="total-slaps">0</span></div>
            <div class="stat">Valid Slaps: <span id="valid-slaps">0</span></div>
            <div class="stat">Game Time: <span id="game-time">00:00</span></div>
        </div>

        <div class="scores" id="scores">
            <!-- Scores will be inserted dynamically -->
        </div>

        <div class="game-area">
            <div id="players-container" style="display:flex; justify-content:center; flex-wrap:wrap; gap:2em; width:100%;">
                <!-- Player areas inserted dynamically -->
            </div>

            <div class="pile-area">
                <div class="slap-zone" id="slap-zone">SLAP!</div>
                <div class="card face-down" id="pile-card"></div>
                <div class="card-count" id="pile-count">0 cards in pile</div>
            </div>
        </div>

        <div class="message hidden" id="message"></div>

        <div class="controls">
            <button class="btn" id="deal-btn">Deal Card</button>
            <button class="btn" id="new-game-btn">New Game</button>
            <button class="btn" id="menu-btn">Main Menu</button>
        </div>
    </div>

    <!-- Audio -->
    <audio id="sound-slap" src="https://freesound.org/data/previews/269/269749_5121236-lq.mp3"></audio>
    <audio id="sound-deal" src="https://freesound.org/data/previews/64/64156_634166-lq.mp3"></audio>
    <audio id="sound-win" src="https://freesound.org/data/previews/276/276020_5121236-lq.mp3"></audio>
    <audio id="sound-lose" src="https://freesound.org/data/previews/250/250629_4486188-lq.mp3"></audio>

    <script>
        class SlapJackGame {
            constructor() {
                // Screens and buttons
                this.mainMenu = document.getElementById('main-menu');
                this.multiplayerMenu = document.getElementById('multiplayer-menu');
                this.settingsMenu = document.getElementById('settings-menu');
                this.gameContainer = document.getElementById('game-container');
                this.playersContainer = document.getElementById('players-container');

                this.btnComputer = document.getElementById('btn-computer');
                this.btnMultiplayer = document.getElementById('btn-multiplayer');
                this.btnTournament = document.getElementById('btn-tournament');
                this.btnSettings = document.getElementById('btn-settings');
                this.btn2p = document.getElementById('btn-2p');
                this.btn3p = document.getElementById('btn-3p');
                this.btn4p = document.getElementById('btn-4p');
                this.btnBackMp = document.getElementById('btn-back-mp');
                this.btnBackSettings = document.getElementById('btn-back-settings');

                this.dealBtn = document.getElementById('deal-btn');
                this.newGameBtn = document.getElementById('new-game-btn');
                this.menuBtn = document.getElementById('menu-btn');
                this.slapZone = document.getElementById('slap-zone');
                this.pileCard = document.getElementById('pile-card');
                this.message = document.getElementById('message');
                this.scores = document.getElementById('scores');

                // Settings elements
                this.slapTimer = document.getElementById('slap-timer');
                this.timerValue = document.getElementById('timer-value');
                this.soundToggle = document.getElementById('sound-toggle');
                this.animationsToggle = document.getElementById('animations-toggle');

                // Stats elements
                this.roundCount = document.getElementById('round-count');
                this.totalSlaps = document.getElementById('total-slaps');
                this.validSlaps = document.getElementById('valid-slaps');
                this.gameTime = document.getElementById('game-time');

                // Sounds
                this.soundSlap = document.getElementById('sound-slap');
                this.soundDeal = document.getElementById('sound-deal');
                this.soundWin = document.getElementById('sound-win');
                this.soundLose = document.getElementById('sound-lose');

                // Game data
                this.players = [];
                this.pile = [];
                this.currentCard = null;
                this.gameActive = false;
                this.activePlayerIndex = 0;
                this.slapTimeout = null;
                this.gameStartTime = null;
                this.gameTimer = null;
                this.roundNumber = 1;
                this.totalSlapsCount = 0;
                this.validSlapsCount = 0;
                this.settings = {
                    slapTimeLimit: 2.5,
                    soundEnabled: true,
                    animationsEnabled: true
                };

                this.bindMenuEvents();
                this.bindGameEvents();
                this.bindSettingsEvents();
                this.showScreen('main-menu');
            }

            bindMenuEvents() {
                this.btnComputer.addEventListener('click', () => {
                    this.setupGame(1);
                    this.showGameScreen();
                    this.newGame();
                });

                this.btnMultiplayer.addEventListener('click', () => {
                    this.showScreen('multiplayer-menu');
                });

                this.btnTournament.addEventListener('click', () => {
                    this.setupTournament();
                    this.showGameScreen();
                    this.newGame();
                });

                this.btnSettings.addEventListener('click', () => {
                    this.showScreen('settings-menu');
                });

                this.btn2p.addEventListener('click', () => {
                    this.setupGame(2);
                    this.showGameScreen();
                    this.newGame();
                });

                this.btn3p.addEventListener('click', () => {
                    this.setupGame(3);
                    this.showGameScreen();
                    this.newGame();
                });

                this.btn4p.addEventListener('click', () => {
                    this.setupGame(4);
                    this.showGameScreen();
                    this.newGame();
                });

                this.btnBackMp.addEventListener('click', () => {
                    this.showScreen('main-menu');
                });

                this.btnBackSettings.addEventListener('click', () => {
                    this.showScreen('main-menu');
                });

                this.menuBtn.addEventListener('click', () => {
                    this.showScreen('main-menu');
                });
            }

            bindSettingsEvents() {
                this.slapTimer.addEventListener('input', (e) => {
                    this.settings.slapTimeLimit = parseFloat(e.target.value);
                    this.timerValue.textContent = e.target.value + 's';
                });

                this.soundToggle.addEventListener('change', (e) => {
                    this.settings.soundEnabled = e.target.checked;
                });

                this.animationsToggle.addEventListener('change', (e) => {
                    this.settings.animationsEnabled = e.target.checked;
                });
            }

            bindGameEvents() {
                this.dealBtn.addEventListener('click', () => this.dealCard());
                this.newGameBtn.addEventListener('click', () => this.newGame());
                this.slapZone.addEventListener('click', () => this.slap(0)); // Player 1 slaps

                document.addEventListener('keydown', e => {
                    if (!this.gameActive) return;
                    
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.slap(1); // Player 2 slaps
                    } else if (e.code === 'Enter') {
                        e.preventDefault();
                        this.slap(2); // Player 3 slaps
                    } else if (e.code === 'KeyR') {
                        e.preventDefault();
                        this.slap(3); // Player 4 slaps
                    }
                });
            }

            showScreen(screenId) {
                this.mainMenu.style.display = 'none';
                this.multiplayerMenu.style.display = 'none';
                this.settingsMenu.style.display = 'none';
                this.gameContainer.style.display = 'none';

                if (screenId === 'main-menu') this.mainMenu.style.display = 'block';
                else if (screenId === 'multiplayer-menu') this.multiplayerMenu.style.display = 'block';
                else if (screenId === 'settings-menu') this.settingsMenu.style.display = 'block';
                else if (screenId === 'game-screen') this.gameContainer.style.display = 'block';
            }

            showGameScreen() {
                this.showScreen('game-screen');
            }

            setupTournament() {
                this.numPlayers = 4;
                this.players = [];

                // Setup tournament with 2 humans and 2 computers
                for (let i = 0; i < this.numPlayers; i++) {
                    this.players.push({
                        name: i < 2 ? `Player ${i + 1}` : `Computer ${i - 1}`,
                        hand: [],
                        score: 0,
                        isComputer: i >= 2,
                        elements: {},
                        // Computer AI properties
                        reactionTime: i === 2 ? 800 : 1200, // Different difficulty levels
                        slapAccuracy: i === 2 ? 0.95 : 0.85, // Different accuracy levels
                        lastSlapTime: 0
                    });
                }

                this.createPlayerUI();
            }

            setupGame(numPlayers) {
                this.numPlayers = numPlayers;
                this.players = [];

                // Setup players - all human players for multiplayer
                for (let i = 0; i < numPlayers; i++) {
                    this.players.push({
                        name: `Player ${i + 1}`,
                        hand: [],
                        score: 0,
                        isComputer: false,
                        elements: {},
                        // Human player properties
                        reactionTime: 0,
                        slapAccuracy: 1.0,
                        lastSlapTime: 0
                    });
                }

                this.createPlayerUI();
            }

            createPlayerUI() {
                // Create player UI areas
                this.playersContainer.innerHTML = '';
                this.scores.innerHTML = '';
                
                this.players.forEach((player, idx) => {
                    // Create player area
                    const div = document.createElement('div');
                    div.classList.add('player-area');
                    div.id = `player-${idx}`;
                    
                    // Add input method indicator
                    let inputMethod = '';
                    if (idx === 0) inputMethod = '(Click to slap)';
                    else if (idx === 1) inputMethod = '(Spacebar to slap)';
                    else if (idx === 2) inputMethod = '(Return to slap)';
                    else if (idx === 3) inputMethod = '(R key to slap)';
                    
                    div.innerHTML = `
                        <h3>${player.name}</h3>
                        <div class="input-method">${inputMethod}</div>
                        <div class="card-count" id="cards-count-${idx}">0 cards</div>
                        <div class="card face-down" id="top-card-${idx}"></div>
                        <div class="player-status" id="status-${idx}"></div>
                    `;
                    this.playersContainer.appendChild(div);

                    // Create score display
                    const scoreDiv = document.createElement('div');
                    scoreDiv.classList.add('score');
                    scoreDiv.innerHTML = `${player.name}: <span id="score-${idx}">0</span>`;
                    this.scores.appendChild(scoreDiv);

                    player.elements.topCard = div.querySelector(`#top-card-${idx}`);
                    player.elements.cardsCount = div.querySelector(`#cards-count-${idx}`);
                    player.elements.score = document.querySelector(`#score-${idx}`);
                    player.elements.area = div;
                    player.elements.status = div.querySelector(`#status-${idx}`);
                });
            }

            newGame() {
                this.createDeck();
                this.shuffleDeck();
                this.pile = [];
                this.currentCard = null;
                this.gameActive = true;
                this.activePlayerIndex = 0;
                this.clearTimeouts();
                this.gameStartTime = Date.now();
                this.startGameTimer();

                // Deal cards evenly to players
                let playerIndex = 0;
                while (this.deck.length > 0) {
                    const card = this.deck.pop();
                    this.players[playerIndex].hand.push(card);
                    playerIndex = (playerIndex + 1) % this.players.length;
                }

                // Reset scores
                this.players.forEach(p => {
                    p.score = 0;
                });

                this.updateScores();
                this.updateDisplay();
                this.showMessage('New game started! Player 1 deals.', 'info');
                this.dealBtn.disabled = false;
                this.updateActivePlayerUI();
            }

            startGameTimer() {
                this.gameTimer = setInterval(() => {
                    if (this.gameActive) {
                        const elapsed = Math.floor((Date.now() - this.gameStartTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        this.gameTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }

            createDeck() {
                const suits = ['♠', '♥', '♦', '♣'];
                const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
                
                this.deck = [];
                for (let suit of suits) {
                    for (let value of values) {
                        this.deck.push({ suit, value });
                    }
                }
            }

            shuffleDeck() {
                for (let i = this.deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
                }
            }

            updateActivePlayerUI() {
                this.players.forEach((player, idx) => {
                    if (idx === this.activePlayerIndex) {
                        player.elements.area.classList.add('active');
                        player.elements.status.textContent = '🎯 Your Turn!';
                        player.elements.status.style.color = '#2ecc71';
                        player.elements.status.style.fontWeight = 'bold';
                    } else {
                        player.elements.area.classList.remove('active');
                        if (player.isComputer) {
                            player.elements.status.textContent = '🤖 Computer';
                            player.elements.status.style.color = '#e74c3c';
                        } else {
                            player.elements.status.textContent = '⏳ Waiting...';
                            player.elements.status.style.color = '#95a5a6';
                        }
                        player.elements.status.style.fontWeight = 'normal';
                    }
                });
            }

            dealCard() {
                if (!this.gameActive) return;
                const activePlayer = this.players[this.activePlayerIndex];
                if (activePlayer.hand.length === 0) {
                    this.showMessage(`${activePlayer.name} has no cards left! Skipping turn.`, 'error');
                    this.nextTurn();
                    return;
                }

                if (this.settings.soundEnabled) {
                    this.soundDeal.play();
                }

                this.currentCard = activePlayer.hand.shift();
                this.pile.unshift(this.currentCard);
                this.updateDisplay();
                this.showMessage(`${activePlayer.name} dealt ${this.cardString(this.currentCard)}`, 'info');

                // Add deal animation
                if (this.settings.animationsEnabled) {
                    this.pileCard.classList.add('dealt');
                    setTimeout(() => this.pileCard.classList.remove('dealt'), 500);
                }

                // Allow slapping for configured time
                this.dealBtn.disabled = true;
                this.slapZone.style.borderColor = '#ff4757';
                this.slapZone.classList.add('active');

                clearTimeout(this.slapTimeout);
                this.slapTimeout = setTimeout(() => {
                    this.slapZone.style.borderColor = '#444';
                    this.slapZone.classList.remove('active');
                    this.showMessage('Time\'s up! No valid slap.', 'info');
                    this.nextTurn();
                }, this.settings.slapTimeLimit * 1000);

                // Trigger computer slap attempts
                this.triggerComputerSlaps();
            }

            triggerComputerSlaps() {
                const computerPlayers = this.players.filter(p => p.isComputer);
                
                computerPlayers.forEach((computer, index) => {
                    if (this.isValidSlap()) {
                        // Computer decides whether to slap based on accuracy
                        if (Math.random() < computer.slapAccuracy) {
                            const delay = computer.reactionTime + Math.random() * 500; // Add some randomness
                            
                            setTimeout(() => {
                                if (this.gameActive && this.isValidSlap()) {
                                    this.computerSlap(computer);
                                }
                            }, delay);
                        }
                    }
                });
            }

            computerSlap(computer) {
                if (!this.gameActive) return;

                this.totalSlapsCount++;
                this.updateStats();

                if (this.isValidSlap()) {
                    if (this.settings.soundEnabled) {
                        this.soundSlap.play();
                    }

                    this.validSlapsCount++;
                    this.updateStats();

                    this.showMessage(`${computer.name} made a valid slap!`, 'success');
                    this.createParticles(this.slapZone);

                    computer.hand.push(...this.pile.reverse());
                    computer.score += this.pile.length;
                    this.pile = [];
                    this.currentCard = null;

                    this.updateScores();
                    this.updateDisplay();

                    this.activePlayerIndex = this.players.indexOf(computer);
                    this.updateActivePlayerUI();
                    this.dealBtn.disabled = this.players[this.activePlayerIndex].isComputer;
                    this.clearTimeouts();
                    this.slapZone.classList.remove('active');

                    // If computer won, continue their turn
                    if (this.players[this.activePlayerIndex].isComputer) {
                        setTimeout(() => {
                            if (this.gameActive && this.players[this.activePlayerIndex].hand.length > 0) {
                                this.dealCard();
                            } else {
                                this.nextTurn();
                            }
                        }, 1000);
                    }
                } else {
                    if (this.settings.soundEnabled) {
                        this.soundLose.play();
                    }
                    this.showMessage(`${computer.name} made an invalid slap! Penalty!`, 'error');
                    if (computer.hand.length > 0) {
                        const lostCard = computer.hand.shift();
                        this.pile.unshift(lostCard);
                        this.updateDisplay();
                    }
                }
            }

            slap(playerIndex) {
                if (!this.gameActive || playerIndex >= this.players.length) return;

                const player = this.players[playerIndex];
                const now = Date.now();
                
                // Prevent rapid-fire slapping (minimum 200ms between slaps)
                if (now - player.lastSlapTime < 200) {
                    return;
                }
                
                player.lastSlapTime = now;
                this.totalSlapsCount++;
                this.updateStats();

                if (this.isValidSlap()) {
                    if (this.settings.soundEnabled) {
                        this.soundSlap.play();
                    }

                    this.validSlapsCount++;
                    this.updateStats();

                    this.showMessage(`${player.name} made a valid slap!`, 'success');
                    this.createParticles(this.slapZone);

                    player.hand.push(...this.pile.reverse());
                    player.score += this.pile.length;
                    this.pile = [];
                    this.currentCard = null;

                    this.updateScores();
                    this.updateDisplay();

                    this.activePlayerIndex = playerIndex;
                    this.updateActivePlayerUI();
                    this.dealBtn.disabled = this.players[this.activePlayerIndex].isComputer;
                    this.clearTimeouts();
                    this.slapZone.classList.remove('active');

                    // If computer won, continue their turn
                    if (this.players[this.activePlayerIndex].isComputer) {
                        setTimeout(() => {
                            if (this.gameActive && this.players[this.activePlayerIndex].hand.length > 0) {
                                this.dealCard();
                            } else {
                                this.nextTurn();
                            }
                        }, 1000);
                    }
                } else {
                    if (this.settings.soundEnabled) {
                        this.soundLose.play();
                    }
                    this.showMessage(`${player.name} made an invalid slap! Penalty!`, 'error');
                    if (player.hand.length > 0) {
                        const lostCard = player.hand.shift();
                        this.pile.unshift(lostCard);
                        this.updateDisplay();
                    }
                }
            }

            createParticles(element) {
                if (!this.settings.animationsEnabled) return;
                
                for (let i = 0; i < 10; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = element.offsetLeft + element.offsetWidth / 2 + 'px';
                    particle.style.top = element.offsetTop + element.offsetHeight / 2 + 'px';
                    particle.style.background = `hsl(${Math.random() * 360}, 70%, 60%)`;
                    particle.style.width = '8px';
                    particle.style.height = '8px';
                    particle.style.borderRadius = '50%';
                    document.body.appendChild(particle);

                    setTimeout(() => particle.remove(), 1000);
                }
            }

            isValidSlap() {
                if (this.pile.length === 0) return false;

                // Valid if top card is Jack
                if (this.pile[0].value === 'J') return true;

                // Or if top two cards have same value
                if (this.pile.length > 1 && this.pile[0].value === this.pile[1].value) return true;

                // Or sandwich (top card value same as third card value)
                if (this.pile.length > 2 && this.pile[0].value === this.pile[2].value) return true;

                return false;
            }

            nextTurn() {
                this.activePlayerIndex = (this.activePlayerIndex + 1) % this.players.length;
                this.updateActivePlayerUI();

                // Enable deal button for all human players
                this.dealBtn.disabled = this.players[this.activePlayerIndex].isComputer;

                this.showMessage(`${this.players[this.activePlayerIndex].name}'s turn to deal.`, 'info');

                // Auto-deal for computer players
                if (this.players[this.activePlayerIndex].isComputer) {
                    setTimeout(() => {
                        if (this.gameActive && this.players[this.activePlayerIndex].hand.length > 0) {
                            this.dealCard();
                        } else {
                            this.nextTurn();
                        }
                    }, 1000);
                }
            }

            updateScores() {
                this.players.forEach(player => {
                    player.elements.score.textContent = player.score;
                });

                // Highlight winner
                const maxScore = Math.max(...this.players.map(p => p.score));
                this.players.forEach(player => {
                    const scoreElement = player.elements.score.parentElement;
                    if (player.score === maxScore && maxScore > 0) {
                        scoreElement.classList.add('winner');
                    } else {
                        scoreElement.classList.remove('winner');
                    }
                });
            }

            updateStats() {
                this.totalSlaps.textContent = this.totalSlapsCount;
                this.validSlaps.textContent = this.validSlapsCount;
            }

            updateDisplay() {
                // Update pile card display
                if (this.currentCard) {
                    this.pileCard.textContent = this.cardString(this.currentCard);
                    this.pileCard.className = 'card';
                    if (this.currentCard.value === 'J') {
                        this.pileCard.classList.add('jack');
                    }
                } else {
                    this.pileCard.textContent = '';
                    this.pileCard.className = 'card face-down';
                }

                // Update player displays
                this.players.forEach(player => {
                    const topCard = player.hand.length > 0 ? player.hand[player.hand.length - 1] : null;

                    player.elements.cardsCount.textContent = `${player.hand.length} cards`;

                    if (topCard) {
                        player.elements.topCard.textContent = this.cardString(topCard);
                        player.elements.topCard.classList.remove('face-down');
                        player.elements.topCard.classList.toggle('jack', topCard.value === 'J');
                    } else {
                        player.elements.topCard.textContent = '';
                        player.elements.topCard.classList.add('face-down');
                        player.elements.topCard.classList.remove('jack');
                    }
                });

                document.getElementById('pile-count').textContent = `${this.pile.length} cards in pile`;

                // Check for game end
                this.checkGameEnd();
            }

            checkGameEnd() {
                const playersWithCards = this.players.filter(p => p.hand.length > 0);
                
                if (playersWithCards.length === 0) {
                    this.endGame('tie');
                } else if (playersWithCards.length === 1) {
                    const winner = playersWithCards[0];
                    this.endGame(winner);
                }
            }

            endGame(result) {
                this.gameActive = false;
                this.dealBtn.disabled = true;
                this.clearTimeouts();
                clearInterval(this.gameTimer);
                this.slapZone.classList.remove('active');

                if (result === 'tie') {
                    if (this.settings.soundEnabled) {
                        this.soundLose.play();
                    }
                    this.showMessage('It\'s a tie!', 'info');
                } else {
                    if (this.settings.soundEnabled) {
                        this.soundWin.play();
                    }
                    this.showMessage(`Congratulations! ${result.name} wins!`, 'success');
                }
            }

            cardString(card) {
                if (!card) return '';
                return `${card.value}${card.suit}`;
            }

            clearTimeouts() {
                clearTimeout(this.slapTimeout);
            }

            showMessage(text, type) {
                this.message.textContent = text;
                this.message.className = `message ${type}`;
                this.message.classList.remove('hidden');
                
                setTimeout(() => {
                    this.message.classList.add('hidden');
                }, 3000);
            }
        }

        // Initialize the game when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SlapJackGame();
        });
    </script>
</body>
</html>

